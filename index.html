<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Embalses Espa√±a</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0f1e;
    --bg2: #0f1629;
    --bg3: #151e35;
    --border: rgba(99,179,255,0.12);
    --blue: #63b3ff;
    --blue-dim: rgba(99,179,255,0.15);
    --cyan: #4eecd8;
    --cyan-dim: rgba(78,236,216,0.15);
    --yellow: #f5c842;
    --red: #ff6b6b;
    --green: #4ecca3;
    --text: #e8f0ff;
    --text-dim: rgba(232,240,255,0.45);
    --text-mid: rgba(232,240,255,0.7);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ FONDO ANIMADO ‚îÄ‚îÄ */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background:
      radial-gradient(ellipse 80% 50% at 20% 10%, rgba(99,179,255,0.07) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 80%, rgba(78,236,216,0.05) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    position: relative;
    z-index: 10;
    padding: 2rem 2.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
    background: rgba(10,15,30,0.8);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .logo-icon {
    width: 42px;
    height: 42px;
    border-radius: 10px;
    background: linear-gradient(135deg, var(--blue), var(--cyan));
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
  }

  .logo-text h1 {
    font-family: 'Syne', sans-serif;
    font-size: 1.25rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: var(--text);
  }

  .logo-text span {
    font-size: 0.7rem;
    color: var(--text-dim);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  .header-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .badge {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 999px;
    border: 1px solid;
  }

  .badge-blue { border-color: var(--blue); color: var(--blue); background: var(--blue-dim); }
  .badge-cyan { border-color: var(--cyan); color: var(--cyan); background: var(--cyan-dim); }

  #last-update {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  main {
    position: relative;
    z-index: 1;
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 2.5rem 4rem;
  }

  /* ‚îÄ‚îÄ STATS CARDS ‚îÄ‚îÄ */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 2.5rem;
  }

  .stat-card {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 1.4rem 1.6rem;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
    animation: fadeUp 0.5s ease both;
  }

  .stat-card:hover {
    border-color: rgba(99,179,255,0.3);
    transform: translateY(-2px);
  }

  .stat-card::after {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--blue), var(--cyan));
    opacity: 0;
    transition: opacity 0.2s;
  }

  .stat-card:hover::after { opacity: 1; }

  .stat-label {
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 0.6rem;
  }

  .stat-value {
    font-family: 'Syne', sans-serif;
    font-size: 2rem;
    font-weight: 800;
    line-height: 1;
    color: var(--blue);
  }

  .stat-value.cyan { color: var(--cyan); }
  .stat-value.yellow { color: var(--yellow); }
  .stat-value.green { color: var(--green); }

  .stat-sub {
    font-size: 0.65rem;
    color: var(--text-dim);
    margin-top: 0.4rem;
  }

  /* ‚îÄ‚îÄ CONTROLES ‚îÄ‚îÄ */
  .controls {
    display: flex;
    gap: 1rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    align-items: center;
  }

  .search-wrap {
    position: relative;
    flex: 1;
    min-width: 220px;
  }

  .search-wrap::before {
    content: '‚åï';
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-dim);
    font-size: 1.1rem;
    pointer-events: none;
  }

  input[type="text"], select {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s;
    width: 100%;
  }

  input[type="text"] { padding-left: 2.4rem; }

  input[type="text"]:focus, select:focus {
    border-color: var(--blue);
  }

  select option { background: var(--bg2); }

  .btn {
    background: var(--blue-dim);
    border: 1px solid var(--blue);
    border-radius: 10px;
    color: var(--blue);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 0.75rem 1.4rem;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
  }

  .btn:hover { background: rgba(99,179,255,0.25); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }

  /* ‚îÄ‚îÄ TABLA ‚îÄ‚îÄ */
  .table-wrap {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
  }

  .table-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.2rem 1.6rem;
    border-bottom: 1px solid var(--border);
    gap: 1rem;
    flex-wrap: wrap;
  }

  .table-title {
    font-family: 'Syne', sans-serif;
    font-size: 0.9rem;
    font-weight: 700;
    color: var(--text);
  }

  #result-count {
    font-size: 0.7rem;
    color: var(--text-dim);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    font-size: 0.62rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-dim);
    padding: 0.9rem 1.4rem;
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
  }

  thead th:hover { color: var(--blue); }

  thead th.sorted { color: var(--blue); }

  tbody tr {
    border-bottom: 1px solid rgba(99,179,255,0.05);
    transition: background 0.15s;
    animation: fadeIn 0.3s ease both;
    cursor: pointer;
  }

  tbody tr:hover { background: rgba(99,179,255,0.04); }
  tbody tr:last-child { border-bottom: none; }

  td {
    padding: 0.9rem 1.4rem;
    font-size: 0.78rem;
    vertical-align: middle;
  }

  .td-nombre {
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 0.82rem;
    color: var(--text);
  }

  .td-cuenca {
    color: var(--text-mid);
    font-size: 0.72rem;
  }

  .td-num {
    font-variant-numeric: tabular-nums;
    color: var(--text-mid);
    text-align: right;
  }

  /* ‚îÄ‚îÄ BARRA DE LLENADO ‚îÄ‚îÄ */
  .fill-wrap {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    min-width: 140px;
  }

  .fill-bar {
    flex: 1;
    height: 6px;
    background: rgba(255,255,255,0.07);
    border-radius: 999px;
    overflow: hidden;
  }

  .fill-inner {
    height: 100%;
    border-radius: 999px;
    transition: width 0.6s ease;
  }

  .fill-pct {
    font-size: 0.72rem;
    font-variant-numeric: tabular-nums;
    min-width: 36px;
    text-align: right;
  }

  .fill-high .fill-inner { background: linear-gradient(90deg, #4ecca3, #63b3ff); }
  .fill-high .fill-pct { color: #4ecca3; }

  .fill-mid .fill-inner { background: linear-gradient(90deg, #f5c842, #ff9f43); }
  .fill-mid .fill-pct { color: #f5c842; }

  .fill-low .fill-inner { background: linear-gradient(90deg, #ff6b6b, #ff9f43); }
  .fill-low .fill-pct { color: #ff6b6b; }

  .fill-na .fill-inner { background: rgba(255,255,255,0.15); }
  .fill-na .fill-pct { color: var(--text-dim); }

  /* ‚îÄ‚îÄ BADGE ELECTRICO ‚îÄ‚îÄ */
  .badge-elec {
    font-size: 0.6rem;
    letter-spacing: 0.08em;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    border: 1px solid rgba(245,200,66,0.4);
    color: var(--yellow);
    background: rgba(245,200,66,0.08);
  }

  /* ‚îÄ‚îÄ MODAL DETALLE ‚îÄ‚îÄ */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(6px);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.25s;
  }

  .modal-overlay.open {
    opacity: 1;
    pointer-events: all;
  }

  .modal {
    background: var(--bg2);
    border: 1px solid rgba(99,179,255,0.25);
    border-radius: 20px;
    width: 100%;
    max-width: 680px;
    max-height: 85vh;
    overflow-y: auto;
    padding: 2rem;
    transform: translateY(20px);
    transition: transform 0.25s;
  }

  .modal-overlay.open .modal { transform: translateY(0); }

  .modal-top {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: 1.5rem;
  }

  .modal-nombre {
    font-family: 'Syne', sans-serif;
    font-size: 1.5rem;
    font-weight: 800;
    line-height: 1.1;
  }

  .modal-cuenca {
    font-size: 0.72rem;
    color: var(--blue);
    margin-top: 0.3rem;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .modal-close {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dim);
    width: 32px;
    height: 32px;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: color 0.2s;
  }

  .modal-close:hover { color: var(--text); }

  .modal-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
    gap: 0.8rem;
    margin-bottom: 1.5rem;
  }

  .modal-stat {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
  }

  .modal-stat-label {
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 0.4rem;
  }

  .modal-stat-val {
    font-family: 'Syne', sans-serif;
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--cyan);
  }

  /* ‚îÄ‚îÄ MINI GR√ÅFICO HIST√ìRICO ‚îÄ‚îÄ */
  .chart-section { margin-top: 1rem; }

  .chart-title {
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-dim);
    margin-bottom: 0.8rem;
  }

  .sparkline-wrap {
    background: var(--bg3);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1rem;
    overflow-x: auto;
  }

  canvas#sparkline {
    display: block;
    width: 100%;
    height: 120px;
  }

  /* ‚îÄ‚îÄ PAGINACI√ìN ‚îÄ‚îÄ */
  .pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
  }

  .page-btn {
    background: var(--bg2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-mid);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 0.5rem 0.9rem;
    cursor: pointer;
    transition: all 0.15s;
  }

  .page-btn:hover { border-color: var(--blue); color: var(--blue); }
  .page-btn.active { background: var(--blue-dim); border-color: var(--blue); color: var(--blue); }
  .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }

  /* ‚îÄ‚îÄ LOADING / ERROR ‚îÄ‚îÄ */
  .loading {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-dim);
    font-size: 0.8rem;
    letter-spacing: 0.08em;
  }

  .loading::after {
    content: '';
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 2px solid var(--border);
    border-top-color: var(--blue);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin-left: 0.8rem;
    vertical-align: middle;
  }

  .error-msg {
    text-align: center;
    padding: 3rem 2rem;
    color: var(--red);
    font-size: 0.8rem;
  }

  .error-msg strong {
    display: block;
    font-family: 'Syne', sans-serif;
    font-size: 1rem;
    margin-bottom: 0.5rem;
  }

  .error-msg code {
    display: block;
    margin-top: 0.8rem;
    font-size: 0.7rem;
    color: var(--text-dim);
    background: var(--bg3);
    padding: 0.5rem 1rem;
    border-radius: 6px;
  }

  /* ‚îÄ‚îÄ ANIMACIONES ‚îÄ‚îÄ */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to   { opacity: 1; }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .stat-card:nth-child(1) { animation-delay: 0.05s; }
  .stat-card:nth-child(2) { animation-delay: 0.10s; }
  .stat-card:nth-child(3) { animation-delay: 0.15s; }
  .stat-card:nth-child(4) { animation-delay: 0.20s; }

  /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    main { padding: 1.5rem 1rem 3rem; }
    header { padding: 1.2rem 1rem; }
    .td-num, th:nth-child(n+4) { display: none; }
    .modal { padding: 1.4rem; }
  }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  ::-webkit-scrollbar-thumb:hover { background: rgba(99,179,255,0.3); }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo">
    <div class="logo-icon">üíß</div>
    <div class="logo-text">
      <h1>Embalses Espa√±a</h1>
      <span>Datos oficiales MITECO</span>
    </div>
  </div>
  <div class="header-meta">
    <span class="badge badge-blue" id="status-badge">Conectando...</span>
    <span id="last-update"></span>
  </div>
</header>

<!-- MAIN -->
<main>

  <!-- STATS -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total embalses</div>
      <div class="stat-value" id="s-total">‚Äî</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Cuencas</div>
      <div class="stat-value cyan" id="s-cuencas">‚Äî</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">√öltima fecha</div>
      <div class="stat-value yellow" style="font-size:1.2rem;padding-top:0.4rem" id="s-fecha">‚Äî</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Con uso el√©ctrico</div>
      <div class="stat-value green" id="s-elec">‚Äî</div>
    </div>
  </div>

  <!-- CONTROLES -->
  <div class="controls">
    <div class="search-wrap">
      <input type="text" id="search" placeholder="Buscar embalse...">
    </div>
    <select id="cuenca-select">
      <option value="">Todas las cuencas</option>
    </select>
    <button class="btn" onclick="resetFiltros()">Limpiar</button>
  </div>

  <!-- TABLA -->
  <div class="table-wrap">
    <div class="table-header">
      <span class="table-title">Inventario de embalses</span>
      <span id="result-count"></span>
    </div>
    <div id="table-container">
      <div class="loading">Cargando datos</div>
    </div>
  </div>

  <!-- PAGINACI√ìN -->
  <div class="pagination" id="pagination"></div>

</main>

<!-- MODAL DETALLE -->
<div class="modal-overlay" id="modal-overlay" onclick="cerrarModal(event)">
  <div class="modal" id="modal">
    <div class="modal-top">
      <div>
        <div class="modal-nombre" id="m-nombre">‚Äî</div>
        <div class="modal-cuenca" id="m-cuenca">‚Äî</div>
      </div>
      <button class="modal-close" onclick="cerrarModal()">‚úï</button>
    </div>
    <div class="modal-stats" id="m-stats"></div>
    <div class="chart-section">
      <div class="chart-title">Hist√≥rico de volumen (√∫ltimos 2 a√±os)</div>
      <div class="sparkline-wrap">
        <canvas id="sparkline"></canvas>
      </div>
    </div>
  </div>
</div>

<script>
const GITHUB_RAW_URL = 'https://raw.githubusercontent.com/charlyglez01-svg/embalses-api/main/datos';

let allData = [];
let filteredData = [];
let currentPage = 1;
const PER_PAGE = 50;
let sortCol = null;
let sortAsc = true;
let searchTerm = '';
let cuencaFiltro = '';

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  await Promise.all([cargarResumen(), cargarCuencas()]);
  await cargarEmbalses();
}

// ‚îÄ‚îÄ RESUMEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarResumen() {
  try {
    const r = await fetch(`${GITHUB_RAW_URL}/resumen.json?t=${Date.now()}`);
    const d = await r.json();
    document.getElementById('s-total').textContent = d.total_embalses ?? '‚Äî';
    document.getElementById('s-cuencas').textContent = d.total_cuencas ?? '‚Äî';
    document.getElementById('s-fecha').textContent = d.ultima_fecha ? formatFecha(d.ultima_fecha) : '‚Äî';
    document.getElementById('last-update').textContent = d.ultima_fecha ? `Datos: ${d.ultima_fecha}` : '';
    document.getElementById('status-badge').textContent = 'En l√≠nea';
    document.getElementById('status-badge').className = 'badge badge-cyan';
  } catch(e) {
    document.getElementById('status-badge').textContent = 'API offline';
    document.getElementById('status-badge').className = 'badge badge-blue';
  }
}

// ‚îÄ‚îÄ CUENCAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarCuencas() {
  try {
    const r = await fetch(`${GITHUB_RAW_URL}/cuencas.json?t=${Date.now()}`);
    const cuencas = await r.json();
    const sel = document.getElementById('cuenca-select');
    cuencas.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c;
      sel.appendChild(opt);
    });
    sel.addEventListener('change', () => {
      cuencaFiltro = sel.value;
      currentPage = 1;
      aplicarFiltros();
    });
  } catch(e) {}
}

// ‚îÄ‚îÄ EMBALSES (todos de una vez para filtrar client-side) ‚îÄ‚îÄ
async function cargarEmbalses() {
  const container = document.getElementById('table-container');
  container.innerHTML = '<div class="loading">Cargando datos</div>';
  try {
    // Cargar todas las p√°ginas
    const first = await fetch(`${GITHUB_RAW_URL}/embalses.json?t=${Date.now()}`).then(r=>r.json());
    allData = Array.isArray(first) ? first : (first.data || []);

    // Contar el√©ctricos
    const elec = allData.filter(e => e.electrico).length;
    document.getElementById('s-elec').textContent = elec;

    filteredData = [...allData];
    renderTabla();
  } catch(e) {
    container.innerHTML = `
      <div class="error-msg">
        <strong>No se puede conectar con la API</strong>
        Aseg√∫rate de que la API est√° corriendo en tu ordenador.
        <code>python api.py</code>
      </div>`;
  }
}

// ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function aplicarFiltros() {
  filteredData = allData.filter(e => {
    const matchSearch = !searchTerm ||
      e.nombre?.toLowerCase().includes(searchTerm) ||
      e.cuenca?.toLowerCase().includes(searchTerm);
    const matchCuenca = !cuencaFiltro || e.cuenca === cuencaFiltro;
    return matchSearch && matchCuenca;
  });

  if (sortCol) ordenar(sortCol, false);

  currentPage = 1;
  renderTabla();
}

function resetFiltros() {
  searchTerm = '';
  cuencaFiltro = '';
  document.getElementById('search').value = '';
  document.getElementById('cuenca-select').value = '';
  filteredData = [...allData];
  currentPage = 1;
  renderTabla();
}

// ‚îÄ‚îÄ ORDENAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ordenar(col, toggle = true) {
  if (toggle) {
    if (sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = true; }
  }
  filteredData.sort((a, b) => {
    let va = a[col], vb = b[col];
    if (va === null || va === undefined) return 1;
    if (vb === null || vb === undefined) return -1;
    if (typeof va === 'string') va = va.toLowerCase();
    if (typeof vb === 'string') vb = vb.toLowerCase();
    return sortAsc ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
  });
  renderTabla();
}

// ‚îÄ‚îÄ RENDER TABLA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderTabla() {
  const container = document.getElementById('table-container');
  const total = filteredData.length;
  const totalPages = Math.ceil(total / PER_PAGE);
  const start = (currentPage - 1) * PER_PAGE;
  const slice = filteredData.slice(start, start + PER_PAGE);

  document.getElementById('result-count').textContent =
    `${total.toLocaleString('es')} embalses`;

  if (slice.length === 0) {
    container.innerHTML = '<div class="loading" style="animation:none">Sin resultados</div>';
    document.getElementById('pagination').innerHTML = '';
    return;
  }

  const cols = [
    { key: 'nombre',          label: 'Embalse' },
    { key: 'cuenca',          label: 'Cuenca' },
    { key: 'capacidad_hm3',   label: 'Capacidad hm¬≥' },
    { key: 'volumen_hm3',     label: 'Agua actual hm¬≥' },
    { key: '_llenado',        label: 'Llenado' },
    { key: 'electrico',       label: 'Uso' },
  ];

  let html = `<table><thead><tr>`;
  cols.forEach(c => {
    const active = sortCol === c.key ? ' sorted' : '';
    const arrow = sortCol === c.key ? (sortAsc ? ' ‚Üë' : ' ‚Üì') : '';
    html += `<th class="${active}" onclick="ordenar('${c.key}')">${c.label}${arrow}</th>`;
  });
  html += `</tr></thead><tbody>`;

  slice.forEach((e, i) => {
    const vol  = e.capacidad_hm3;
    const agua = e.volumen_hm3;
    const pct  = e.porcentaje !== null && e.porcentaje !== undefined ? Math.min(100, Math.round(e.porcentaje)) : null;
    const fillClass = pct === null ? 'fill-na' : pct >= 60 ? 'fill-high' : pct >= 30 ? 'fill-mid' : 'fill-low';
    const pctText = pct !== null ? pct + '%' : '‚Äî';
    const barW = pct !== null ? pct : 0;
    const delay = Math.min(i * 0.02, 0.4);

    html += `<tr style="animation-delay:${delay}s" onclick="abrirModal('${encodeURIComponent(e.nombre)}')">
      <td class="td-nombre">${e.nombre ?? '‚Äî'}</td>
      <td class="td-cuenca">${e.cuenca ?? '‚Äî'}</td>
      <td class="td-num">${vol != null ? vol.toLocaleString('es') : '‚Äî'}</td>
      <td class="td-num">${agua != null ? agua.toLocaleString('es') : '‚Äî'}</td>
      <td>
        <div class="fill-wrap ${fillClass}">
          <div class="fill-bar"><div class="fill-inner" style="width:${barW}%"></div></div>
          <span class="fill-pct">${pctText}</span>
        </div>
      </td>
      <td>${e.electrico ? '<span class="badge-elec">‚ö° El√©ctrico</span>' : ''}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  container.innerHTML = html;

  renderPaginacion(totalPages);
}

// ‚îÄ‚îÄ PAGINACI√ìN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPaginacion(total) {
  const pag = document.getElementById('pagination');
  if (total <= 1) { pag.innerHTML = ''; return; }

  let html = `<button class="page-btn" ${currentPage===1?'disabled':''} onclick="irPagina(${currentPage-1})">‚Üê Anterior</button>`;

  const start = Math.max(1, currentPage - 2);
  const end   = Math.min(total, currentPage + 2);

  if (start > 1) html += `<button class="page-btn" onclick="irPagina(1)">1</button>${start>2?'<span style="color:var(--text-dim);padding:0 0.3rem">‚Ä¶</span>':''}`;
  for (let p = start; p <= end; p++) {
    html += `<button class="page-btn ${p===currentPage?'active':''}" onclick="irPagina(${p})">${p}</button>`;
  }
  if (end < total) html += `${end<total-1?'<span style="color:var(--text-dim);padding:0 0.3rem">‚Ä¶</span>':''}<button class="page-btn" onclick="irPagina(${total})">${total}</button>`;

  html += `<button class="page-btn" ${currentPage===total?'disabled':''} onclick="irPagina(${currentPage+1})">Siguiente ‚Üí</button>`;
  pag.innerHTML = html;
}

function irPagina(p) {
  currentPage = p;
  renderTabla();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ‚îÄ‚îÄ MODAL DETALLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function abrirModal(nombreEnc) {
  const nombre = decodeURIComponent(nombreEnc);
  const overlay = document.getElementById('modal-overlay');
  overlay.classList.add('open');

  document.getElementById('m-nombre').textContent = nombre;
  document.getElementById('m-cuenca').textContent = '‚Äî';
  document.getElementById('m-stats').innerHTML = '<div style="color:var(--text-dim);font-size:0.75rem">Cargando...</div>';

  try {
    const nombreSafe = nombre.replace(/[/\\]/g,"_").replace(/ /g,"_");
    const r = await fetch(`${GITHUB_RAW_URL}/embalses/${nombreSafe}.json`);
    const d = await r.json();
    const u = d.ultimo_dato || {};

    document.getElementById('m-cuenca').textContent = d.cuenca ?? '‚Äî';

    const stats = [
      { label: 'Capacidad hm¬≥',    val: u.capacidad_hm3 ?? '‚Äî',     color: 'var(--cyan)' },
      { label: 'Agua actual hm¬≥',  val: u.volumen_hm3 ?? '‚Äî',       color: 'var(--blue)' },
      { label: 'Llenado',          val: u.porcentaje != null ? u.porcentaje + '%' : '‚Äî', color: u.porcentaje >= 60 ? 'var(--green)' : u.porcentaje >= 30 ? 'var(--yellow)' : 'var(--red)' },
      { label: 'Fecha dato',       val: u.fecha ? formatFecha(u.fecha) : '‚Äî', color: 'var(--yellow)', size: '1rem' },
      { label: 'Uso el√©ctrico',    val: d.ultimo_dato?.electrico ? 'S√≠ ‚ö°' : 'No', color: d.ultimo_dato?.electrico ? 'var(--yellow)' : 'var(--text-dim)' },
    ];

    document.getElementById('m-stats').innerHTML = stats.map(s => `
      <div class="modal-stat">
        <div class="modal-stat-label">${s.label}</div>
        <div class="modal-stat-val" style="color:${s.color};font-size:${s.size||'1.3rem'}">${s.val}</div>
      </div>`).join('');

    // Mini gr√°fico
    dibujarSparkline(d.historico || []);

  } catch(e) {
    document.getElementById('m-stats').innerHTML = '<div style="color:var(--red);font-size:0.75rem">Error al cargar detalle</div>';
  }
}

function cerrarModal(e) {
  if (e && e.target !== document.getElementById('modal-overlay')) return;
  document.getElementById('modal-overlay').classList.remove('open');
}

// ‚îÄ‚îÄ SPARKLINE CANVAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function dibujarSparkline(historico) {
  const canvas = document.getElementById('sparkline');
  const ctx = canvas.getContext('2d');

  // √öltimos 2 a√±os
  const hace2a√±os = new Date();
  hace2a√±os.setFullYear(hace2a√±os.getFullYear() - 2);

  const datos = historico
    .filter(h => h.fecha && new Date(h.fecha) >= hace2a√±os && h.volumen_hm3 != null)
    .reverse();

  canvas.width = canvas.offsetWidth || 600;
  canvas.height = 120;
  const W = canvas.width, H = canvas.height;
  const pad = { top: 10, right: 10, bottom: 20, left: 40 };

  ctx.clearRect(0, 0, W, H);

  if (datos.length < 2) {
    ctx.fillStyle = 'rgba(232,240,255,0.3)';
    ctx.font = '12px DM Mono';
    ctx.fillText('Sin datos suficientes', W/2 - 70, H/2);
    return;
  }

  const vals = datos.map(d => d.volumen_hm3);
  const minV = Math.min(...vals);
  const maxV = Math.max(...vals);
  const range = maxV - minV || 1;

  const xScale = (W - pad.left - pad.right) / (datos.length - 1);
  const yScale = (H - pad.top - pad.bottom) / range;

  const toX = i  => pad.left + i * xScale;
  const toY = v  => H - pad.bottom - (v - minV) * yScale;

  // √Årea rellena
  const grad = ctx.createLinearGradient(0, pad.top, 0, H - pad.bottom);
  grad.addColorStop(0, 'rgba(99,179,255,0.25)');
  grad.addColorStop(1, 'rgba(99,179,255,0)');

  ctx.beginPath();
  ctx.moveTo(toX(0), toY(vals[0]));
  datos.forEach((_, i) => { if (i > 0) ctx.lineTo(toX(i), toY(vals[i])); });
  ctx.lineTo(toX(datos.length - 1), H - pad.bottom);
  ctx.lineTo(toX(0), H - pad.bottom);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();

  // L√≠nea
  ctx.beginPath();
  ctx.moveTo(toX(0), toY(vals[0]));
  datos.forEach((_, i) => { if (i > 0) ctx.lineTo(toX(i), toY(vals[i])); });
  ctx.strokeStyle = 'rgba(99,179,255,0.8)';
  ctx.lineWidth = 1.5;
  ctx.stroke();

  // Ejes Y m√≠nimo/m√°ximo
  ctx.fillStyle = 'rgba(232,240,255,0.3)';
  ctx.font = '9px DM Mono';
  ctx.fillText(maxV.toFixed(0), 2, pad.top + 8);
  ctx.fillText(minV.toFixed(0), 2, H - pad.bottom - 2);

  // Etiquetas X (a√±os)
  const a√±os = [...new Set(datos.map(d => d.fecha?.slice(0,4)))];
  a√±os.forEach(a√±o => {
    const idx = datos.findIndex(d => d.fecha?.startsWith(a√±o));
    if (idx >= 0) {
      ctx.fillStyle = 'rgba(232,240,255,0.2)';
      ctx.fillText(a√±o, toX(idx), H - 4);
    }
  });
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatFecha(f) {
  if (!f) return '‚Äî';
  const [y, m, d] = f.split('-');
  const meses = ['','Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
  return `${d} ${meses[parseInt(m)]} ${y}`;
}

// ‚îÄ‚îÄ B√öSQUEDA con debounce ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let debounceTimer;
document.getElementById('search').addEventListener('input', e => {
  clearTimeout(debounceTimer);
  debounceTimer = setTimeout(() => {
    searchTerm = e.target.value.toLowerCase().trim();
    currentPage = 1;
    aplicarFiltros();
  }, 250);
});

// ‚îÄ‚îÄ ESC cierra modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('modal-overlay').classList.remove('open');
});

// ‚îÄ‚îÄ ARRANCAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
init();
</script>
</body>
</html>
